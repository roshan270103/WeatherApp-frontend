@using Weatherfrontend.Services
@inject AuthState AuthState
@inject NavigationManager Navigation

@if (isNavLoading)
{
    <div class="app-loading-overlay">
        <div class="spinner"></div>
        <span>Loading...</span>
    </div>
}

<CascadingAuthenticationState>
    @if (!isLoaded)
    {
        <div class="app-loading-overlay">
            <div class="spinner"></div>
            <span>Loading your app...</span>
        </div>
    }
    else
    {
        <Router AppAssembly="@typeof(App).Assembly">
            <Found Context="routeData">
                @if (AuthState.IsLoggedIn
                    || routeData.PageType == typeof(Pages.Home)
                    || routeData.PageType == typeof(Pages.Login)
                    || routeData.PageType == typeof(Pages.Register))
                {
                    <RouteView RouteData="@routeData" DefaultLayout="@typeof(MainLayout)" />
                }
                else
                {
                    <LayoutView Layout="@typeof(MainLayout)">
                        <div class="text-center mt-5" style="color:white;">
                            <h4>🔒 You must be logged in to access this page.</h4>
                            <p>Please log in from the navigation menu.</p>
                        </div>
                    </LayoutView>
                }
            </Found>
            <NotFound>
                <LayoutView Layout="@typeof(MainLayout)">
                    <p role="alert" style="color:white;">Sorry, there's nothing at this address.</p>
                </LayoutView>
            </NotFound>
        </Router>
    }
</CascadingAuthenticationState>

@code {
    private bool isLoaded = false;
    private bool isNavLoading = false;

    protected override async Task OnInitializedAsync()
    {
        Navigation.LocationChanged += OnLocationChanged;
        await AuthState.LoadStateAsync();
        isLoaded = true;
    }

    private void OnLocationChanged(object sender, Microsoft.AspNetCore.Components.Routing.LocationChangedEventArgs e)
    {
        isNavLoading = true;
        StateHasChanged();
        _ = Task.Run(async () =>
        {
            await Task.Delay(800); // Duration of loading overlay in ms
            isNavLoading = false;
            StateHasChanged();
        });
    }

    public void Dispose()
    {
        Navigation.LocationChanged -= OnLocationChanged;
    }
}
