@page "/"
@using System.Net.Http.Json
@using Microsoft.AspNetCore.Components.Web
@inject HttpClient Http
@inject IJSRuntime JS
@inject Weatherfrontend.Services.AuthState AuthState
@inject NavigationManager Navigation

@if (isSectionLoading)
{
    <div class="section-loading-overlay">
        <div class="spinner"></div>
        <span>Loading...</span>
    </div>
}

@if (weather == null)
{
    <div class="welcome-section animate-fade-in">
        <h1 class="welcome-title">Welcome 👋</h1>
        <p class="welcome-subtitle">Check your weather instantly for any city worldwide</p>
        <div class="search-center-row">
            <input class="weather-input"
                   @bind="city"
                   placeholder="Enter city..."
                   @onkeydown="HandleSearchEnter" />
            <button class="weather-btn" @onclick="@(() => GetWeather(false))">Search</button>
            <button class="btn-location" @onclick="@(async () => await ManualLocationLoad())">
                <span class="material-icons" style="vertical-align:middle;">my_location</span> Get My Location
            </button>
        </div>
    </div>
}

@if (weather != null)
{
    <div class="weather-hero animate-hero"
         style="background-image:
                        linear-gradient(180deg, rgba(0,0,0,.25), rgba(0,0,0,.25)),
                        url('@GetWeatherBackgroundImage()');">
        <div>
            <h1 style="font-size:2.4rem;">@weather.name</h1>
            <div class="weather-hero-date">
                @DateTime.Now.ToString("dddd, MMM dd yyyy · hh:mm tt")
            </div>
            <div class="weather-info-row">
                <div class="weather-info-card">Wind @weather.wind.speed m/s</div>
                <div class="weather-info-card">@weather.weather[0].description</div>
            </div>
        </div>
        <div class="weather-today-card">
            <img src="@($"https://openweathermap.org/img/wn/{weather.weather[0].icon}@2x.png")" />
            <div class="weather-today-temp">@weather.main.temp°C</div>
        </div>
    </div>
    <div class="search-hero animate-fade-in">
        <input class="search-input"
               @bind="city"
               placeholder="Search another city..."
               @onkeydown="HandleSearchEnter" />
        <button class="btn-search" @onclick="@(() => GetWeather(false))">Search</button>
        <button class="btn-location" @onclick="@(async () => await ManualLocationLoad())">
            <span class="material-icons" style="vertical-align:middle;">my_location</span> Get My Location
        </button>
    </div>
}

@if (forecastDays != null && forecastDays.Any())
{
    <h3 class="forecast-title animate-fade-in">3-Day Forecast</h3>
    <div class="forecast-grid">
        @foreach (var day in forecastDays)
        {
            <div class="forecast-card animate-pop-in">
                <img src="@($"https://openweathermap.org/img/wn/{day.Icon}@2x.png")" />
                <div class="forecast-date">@day.Date.ToString("ddd")</div>
                <div class="forecast-temp">@day.MinTemp°C – @day.MaxTemp°C</div>
                <div class="forecast-desc">@day.Description</div>
            </div>
        }
    </div>
}

@if (!string.IsNullOrWhiteSpace(error))
{
    <div class="auth-message-box error" style="margin-top:18px;">
        <span class="msg-icon">@((error.Contains("unlimited searches")) ? "🔒" : "❌")</span>
        @if (error.Contains("unlimited searches"))
        {
            <span>Login to get unlimited searches!</span>
            <span class="inline-login-subbox">
                <button class="inline-login-btn" @onclick='() => Navigation.NavigateTo("/login")'>
                    Login
                </button>
            </span>
        }
        else
        {
            @error.Replace("❌", "")
        }
    </div>
}

@code {
    private string? city;
    private WeatherResponse? weather;
    private List<ForecastDay> forecastDays = new();
    private string? error;
    private bool isSectionLoading = false;

    private int searchCount = 0;
    private const int searchLimit = 10;
    private bool IsAuthenticated => !string.IsNullOrEmpty(AuthState?.UserId);
    private string currentDay = DateTime.UtcNow.ToString("yyyy-MM-dd");
    private const string owmApiKey = "898c51e8b3072bda4577b3aff97c30e7"; // Set your API key here

    protected override async Task OnInitializedAsync()
    {
        if (!IsAuthenticated)
        {
            var data = await JS.InvokeAsync<SearchData>("getSearchData");
            if (data.day != currentDay)
            {
                searchCount = 0;
                await JS.InvokeVoidAsync("setSearchData", 0, currentDay);
            }
            else
            {
                searchCount = data.count;
            }
        }
        else
        {
            await JS.InvokeVoidAsync("resetSearchData");
            searchCount = 0;
        }

        // Attempt location detection and weather (on page load)
        await TryDetectAndLoadWeather();
    }

    private async Task HandleSearchEnter(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await GetWeather(false);
        }
    }

    private async Task IncrementSearchCount()
    {
        searchCount++;
        await JS.InvokeVoidAsync("setSearchData", searchCount, currentDay);
    }

    private async Task GetWeather(bool isFromLocation = false)
    {
        error = null;
        weather = null;
        forecastDays.Clear();
        isSectionLoading = true;

        if (string.IsNullOrWhiteSpace(city))
        {
            error = "Please enter a city!";
            isSectionLoading = false;
            return;
        }

        // Only count manual searches toward the daily limit
        if (!IsAuthenticated && !isFromLocation)
        {
            if (searchCount >= searchLimit)
            {
                error = "Login to get unlimited searches! (Daily limit reached)";
                isSectionLoading = false;
                return;
            }
            await IncrementSearchCount();
        }

        try
        {
            var weatherUrl = $"https://weatherbackendapi-fbceb0brdmdqgmca.southindia-01.azurewebsites.net/api/weather?city={city}";
            var forecastUrl = "https://weatherbackendapi-fbceb0brdmdqgmca.southindia-01.azurewebsites.net/api/weather/forecast?city=" + city;

            weather = await Http.GetFromJsonAsync<WeatherResponse>(weatherUrl);
            forecastDays = await Http.GetFromJsonAsync<List<ForecastDay>>(forecastUrl);
        }
        catch (Exception ex)
        {
            // Show a clear, user-friendly message if it's a 404/not found,
            // otherwise display a generic friendly message.
            if (ex.Message.Contains("404") || ex.Message.Contains("Not Found") || ex.Message.Contains("net_http_message_not_success_statuscode_reason"))
            {
                error = "❌ City not found. Please input a valid city.";
            }
            else
            {
                error = "❌ Could not fetch weather data. Please try again later.";
            }
        }
        finally
        {
            isSectionLoading = false;
        }
    }

    private async Task TryDetectAndLoadWeather()
    {
        await ManualLocationLoad(true);
    }

    private async Task ManualLocationLoad(bool silentFail = false)
    {
        isSectionLoading = true;
        try
        {
            var coords = await JS.InvokeAsync<LatLong>("getGeolocation");

            var geoUrl = $"https://api.openweathermap.org/geo/1.0/reverse?lat={coords.Latitude}&lon={coords.Longitude}&limit=1&appid={owmApiKey}";
            var geoResults = await Http.GetFromJsonAsync<List<GeoResult>>(geoUrl);

            city = geoResults?.FirstOrDefault()?.name?.Split(' ')[0] ?? null;

            if (!string.IsNullOrWhiteSpace(city))
            {
                await GetWeather(true); // Skip increment, does NOT count against limit
            }
            else if (!silentFail)
            {
                error = "Could not determine your city from location.";
            }
        }
        catch
        {
            if (!silentFail)
            {
                error = "Could not access your location permission.";
            }
        }
        finally
        {
            isSectionLoading = false;
        }
    }

    private string GetWeatherBackgroundImage()
    {
        if (weather?.weather == null || weather.weather.Count == 0)
            return "/images/weather/sunny.jpg";

        var desc = weather.weather[0].description.ToLower();
        if (desc.Contains("rain")) return "/images/weather/rainy.jpg";
        if (desc.Contains("cloud")) return "/images/weather/cloudy.jpg";
        if (desc.Contains("snow")) return "/images/weather/snowy.jpg";
        if (desc.Contains("storm") || desc.Contains("thunder")) return "/images/weather/storm.jpg";
        if (desc.Contains("fog") || desc.Contains("mist") || desc.Contains("haze")) return "/images/weather/foggy.jpg";
        return "/images/weather/sunny.jpg";
    }

    // JS Interop Models
    public class SearchData { public int count { get; set; } public string day { get; set; } }
    public class LatLong { public double Latitude { get; set; } public double Longitude { get; set; } }
    public class GeoResult { public string name { get; set; } }

    // Weather models
    public class WeatherResponse
    {
        public string name { get; set; }
        public Main main { get; set; }
        public List<WeatherInfo> weather { get; set; }
        public Wind wind { get; set; }
    }
    public class Main { public double temp { get; set; } }
    public class WeatherInfo { public string description { get; set; } public string icon { get; set; } }
    public class Wind { public double speed { get; set; } }
    public class ForecastDay
    {
        public DateTime Date { get; set; }
        public double MinTemp { get; set; }
        public double MaxTemp { get; set; }
        public string Icon { get; set; }
        public string Description { get; set; }
    }
}
