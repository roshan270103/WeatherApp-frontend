@page "/login"
@using Weatherfrontend.Services
@using Microsoft.AspNetCore.Components.Web
@inject AuthState authState
@inject NavigationManager NavigationManager
@inject HttpClient Http

<div class="auth-wrapper">
    <div class="auth-card">
        <h2>Welcome Back 👋</h2>
        <p class="auth-subtitle">Login to continue to your weather dashboard</p>

        <input class="auth-input" @bind="email" placeholder="Email" @onkeydown="HandleLoginEnter" />
        <input class="auth-input" @bind="password" type="password" placeholder="Password" @onkeydown="HandleLoginEnter" />

        <button class="auth-btn" @onclick="LoginUser">Login</button>

        @if (!string.IsNullOrEmpty(message))
        {
            <div class="login-error-box animate-fade-in">@message</div>
        }
    </div>
</div>

@code {
    private string email = "";
    private string password = "";
    private string message = "";

    private async Task LoginUser()
    {
        message = "";
        var user = new { email = email, password = password };
        var response = await Http.PostAsJsonAsync(
            "https://weatherbackendapi-fbceb0brdmdqgmca.southindia-01.azurewebsites.net/api/user/login",
            user
        );

        if (response.IsSuccessStatusCode)
        {
            var result = await response.Content.ReadFromJsonAsync<UserInfo>();

            if (result != null && !string.IsNullOrEmpty(result.id))
            {
                await authState.LoginAsync(result.id, result.email, result.accessToken);
                NavigationManager.NavigateTo("/weatherdashboard", true);
            }
            else
            {
                message = "Login failed: Missing user ID or email.";
            }
        }
        else
        {
            var errorMsg = await response.Content.ReadAsStringAsync();
            message = GetFriendlyErrorMessage(errorMsg);
        }
    }

    private async Task HandleLoginEnter(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await LoginUser();
        }
    }

    private string GetFriendlyErrorMessage(string rawJson)
    {
        try
        {
            // Try to parse standard backend error format
            var doc = System.Text.Json.JsonDocument.Parse(rawJson);
            if (doc.RootElement.TryGetProperty("msg", out var msgElem))
                return msgElem.GetString();

            // Fallback for "error_code" or similar
            if (rawJson.Contains("invalid_credentials"))
                return "Invalid email or password. Please try again.";
            if (rawJson.Contains("missing email"))
                return "Please enter your email address.";
            if (rawJson.Contains("validation_failed"))
                return "Email and password are required.";
        }
        catch
        {
            // Fallback for any non-JSON error
        }

        // As default fallback:
        if (rawJson.Contains("invalid_credentials"))
            return "Invalid email or password. Please try again.";
        if (rawJson.Contains("missing email"))
            return "Please enter your email address.";
        if (rawJson.Contains("validation_failed"))
            return "Email and password are required.";
        return "Login failed. Please check your credentials and try again.";
    }

    public class UserInfo
    {
        public string id { get; set; } = "";
        public string email { get; set; } = "";
        public string accessToken { get; set; } = "";
    }
}
