@page "/register"
@inject HttpClient Http
@inject NavigationManager NavigationManager

<div class="auth-wrapper">
    <div class="auth-card">

        <h2>Create Account ✨</h2>
        <p class="auth-subtitle">Join and personalize your weather experience</p>

        <input class="auth-input" @bind="email" placeholder="Email" />
        <input class="auth-input" @bind="password" type="password" placeholder="Password" />
        <input class="auth-input" @bind="confirmPassword" type="password" placeholder="Confirm Password" />

        <button class="auth-btn" @onclick="RegisterUser">Register</button>

        @if (!string.IsNullOrEmpty(message))
        {
            <div class="auth-message-box @((message.Contains("✅") ? "success" : "error"))" style="margin-top:17px;">
                <span class="msg-icon">@((message.Contains("✅")) ? "✅" : "❌")</span>
                @message.Replace("❌", "").Replace("✅", "")
            </div>
        }


    </div>
</div>

@code {
    private string email = "";
    private string password = "";
    private string confirmPassword = "";
    private string message = "";

    private async Task RegisterUser()
    {
        message = "";
        if (password != confirmPassword)
        {
            message = "❌ Passwords do not match.";
            return;
        }
        if (string.IsNullOrWhiteSpace(email) || string.IsNullOrWhiteSpace(password))
        {
            message = "❌ Email and password are required.";
            return;
        }

        var user = new { email = email, password = password };
        var response = await Http.PostAsJsonAsync(
            "https://weatherbackendapi-fbceb0brdmdqgmca.southindia-01.azurewebsites.net/api/user/register",
            user
        );

        if (response.IsSuccessStatusCode)
        {
            message = "✅ Registration successful! Check your email. Redirecting...";
            await Task.Delay(2500);
            NavigationManager.NavigateTo("/login");
        }
        else
        {
            var error = await response.Content.ReadAsStringAsync();
            message = GetRegisterErrorMessage(error);
        }
    }

    private string GetRegisterErrorMessage(string rawJson)
    {
        try
        {
            var doc = System.Text.Json.JsonDocument.Parse(rawJson);
            if (doc.RootElement.TryGetProperty("msg", out var msgElem))
                return "❌ " + msgElem.GetString();

            if (rawJson.Contains("already exists"))
                return "❌ An account with this email already exists.";
            if (rawJson.Contains("validation_failed"))
                return "❌ Registration failed. Please check your input.";
            if (rawJson.Contains("missing"))
                return "❌ Please provide all required fields.";
        }
        catch
        {
            // If not JSON or parsing fails, fallback to generic
        }
        if (rawJson.Contains("already exists"))
            return "❌ An account with this email already exists.";
        if (rawJson.Contains("validation_failed"))
            return "❌ Registration failed. Please check your input.";
        if (rawJson.Contains("missing"))
            return "❌ Please provide all required fields.";
        return "❌ Registration failed. Please try again.";
    }
}
